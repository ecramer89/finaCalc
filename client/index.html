<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <style>
        body {
            font-size: 10px;
            font-family: Verdana;
        }
        #explanatoryText{
            font-size: 8px;
        }
        #resultPanel{
            visibility: hidden;
            display: none;
        }
    </style>
    <title>TaxApple</title>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-sm-4">
            <h4>TSFA or RRSP?</h4>
                <div id="explanatoryText">
                    TSFAs and RRSPs are alternative tax free investment savings account.
                    Both can help you save for retirement, so which should you choose?
                    An <b>RRSP</b> allows you to defer paying tax on your investment.
                    You don't pay any tax on the money you deposit, but you have to pay taxes on the money you withdraw.
                    An <b>TSFA</b> is the opposite. You pay tax when you deposit, but you don't pay any taxes on the money you withdraw.
                    An <b>RRSP</b> is great if you're currently paying a high tax and you don't intend to withdraw until you're retired, when your income and taxes are less.
                    A <b>TSFA</b> is great if you're currently earning less than you expect to and you want to put some money away to save for a house or a car.
                    Still feeling overwhelmed? Our calculator can help.
                    Fill out the form to the right and click 'submit' to see which account is better for you.
                </div>
            </div>
        <div class="col-sm-8" id="formPanel">
            <form onsubmit="calculate()">
                <div class="container">
                    <div class="row" id="calculatorForm"></div>
                </div>
            </form>
        </div>
        </div>
        <div class="row" id="resultPanel">
            <div class="col">
            <h4>Results:</h4>
            <div class="container">
                <div class="row" id="resultLabels">
                    <div class="col">Account Type</div>
                    <div class="col">After-Tax</div>
                    <div class="col">Future-Value</div>
                    <div class="col">Amount Taxed</div>
                    <div class="col">Withdrawal After-Tax</div>
                </div>
                <div class="row" id="TSFA">
                    <div class="col">TSFA</div>
                    <div class="col" id="TSFA-afterTax"></div>
                    <div class="col" id="TSFA-futureValue"></div>
                    <div class="col" id="TSFA-amountTaxedOnWithdrawal"></div>
                    <div class="col" id="TSFA-afterTaxFutureValue"></div>
                </div>
                <div class="row" id="RRSP">
                    <div class="col">RRSP</div>
                    <div class="col" id="RRSP-afterTax"></div>
                    <div class="col" id="RRSP-futureValue"></div>
                    <div class="col" id="RRSP-amountTaxedOnWithdrawal"></div>
                    <div class="col" id="RRSP-afterTaxFutureValue"></div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </body>
<script>


    const calculateURL = "http://localhost:3000/calculate" //note: be sure that you don't change the server code so that it possible pings a different port than 3000
    const percentagePattern = "\\d+(\.\\d+)?"
    const monetaryAmountPattern = "\\d+(\.\\d{1,2})?"
    function parseInputWithPattern(input, pattern){
      const matches = input.match(pattern)
      return matches ? matches[0] : ""
    }

    //add describes that include expected value
    const formFields = {
      currentTaxRate: {label: "Your Current Marginal Tax Rate", placeholder: "15%", pattern: percentagePattern},
      amountInvested: {
        label: "The Amount You Intend To Invest",
        placeholder: "1000.00$",
        pattern: monetaryAmountPattern
      },
      retirementTaxRate: {label: "Your Retirement Tax Rate", placeholder: "5%", pattern: percentagePattern},
      investmentGrowthRate: {label: "Your Investment Growth Rate", placeholder: "2%", pattern: percentagePattern},
      inflationRate: {label: "The Inflation Rate", placeholder: "5%", pattern: percentagePattern},
      yearsInvested: {label: "Years You Plan To Invest", placeholder: "30", pattern: "\\d+"}
    }

    createFormInputFields()

    function createFormInputFields(){
      const fieldsPerCol = 3;
      var formContainer = document.getElementById("calculatorForm")
      const fieldNames = Object.keys(formFields)
      const numFields = fieldNames.length
      var formGroup = createFormGroup()
      formContainer.appendChild(formGroup)
      var currFormGroup = 0

      for(var i = 0; i< numFields;i++){
         const forFormGroup = Math.floor(i/fieldsPerCol)
            if(forFormGroup != currFormGroup){
              formGroup = createFormGroup()
              formContainer.appendChild(formGroup)
              currFormGroup = forFormGroup
            }
        addFormFieldLabelAndInputToFormGroup(formGroup, fieldNames[i])
      }
      formContainer.insertAdjacentHTML("afterEnd",'<div class="row"><button type="submit" class="btn btn-default">Submit</button></div>')
    }

    function createFormGroup(){
      var formGroup = document.createElement("div")
      formGroup.className+="col form-group"
      return formGroup
    }

    function addFormFieldLabelAndInputToFormGroup(formGroup, field){
      const fieldData = formFields[field]
      const label = fieldData.label
      const placeholder= fieldData.placeholder
      formGroup.insertAdjacentHTML("beforeEnd", '<label class="formField" for="'+field+'">'+label+'</label>');
      formGroup.insertAdjacentHTML("beforeEnd", '<input type="text" placeholder="'+placeholder+'" class="form-control formField input-sm" id="'+field+'">');
    }


    var formInput = null //lazily initialize on first call to calculate.
    //elements aren't mounted to DOM when the script initially executes.

    function cacheFormElements(){
      formInput = Object.keys(formFields).reduce(function(acc, field){
        acc[field] = document.getElementById(field)
        return acc
      }, {})
    }

    function calculate() {
      if (!formInput) cacheFormElements();
      var params = Object.keys(formInput).reduce(function (acc, fieldName) {
        acc[fieldName] = parseInputWithPattern(formInput[fieldName].value, formFields[fieldName].pattern)
        return acc
      }, {});


      var request = new XMLHttpRequest()

      request.open("POST", calculateURL, true)
      request.setRequestHeader("Accept", "application/json")
      request.setRequestHeader("Content-Type", "application/json")

      request.onreadystatechange = function () {
        if (request.readyState === XMLHttpRequest.DONE) {
          switch (request.status) {
            case 200:
              const data = JSON.parse(request.responseText)
              alert(request.responseText)
              displayInResultsPanels(data)
              break;
            case 400:
              const errors = JSON.parse(request.responseText)
              errors.forEach(function (err) {
                injectErrorMessageIntoRelevantField(err)
              })
              break;
          }

        }
      }

      request.send(JSON.stringify(params))
      event.preventDefault()
    }

      function displayInResultsPanels(data){
        const resultsPanel = document.getElementById("resultPanel")
        resultsPanel.style.visibility = "visible"
        resultsPanel.style.display = "block"
        const TSFAResults = document.getElementById("TSFA")
        const RRSPResults = document.getElementById("RRSP")
        displayReturnsForTaxAccount(TSFAResults, data.TSFA)
        displayReturnsForTaxAccount(RRSPResults, data.RRSP)
      }

      function displayReturnsForTaxAccount(accountResultsPanel, dataForPanel){
        const accountType = accountResultsPanel.id
        const resultsFieldNames=Object.keys(dataForPanel)
        for(const fieldName of resultsFieldNames){
          const id = accountType+"-"+fieldName
          const resultCell = document.getElementById(id)
          resultCell.innerHTML = dataForPanel[fieldName]
        }

      }



      function injectErrorMessageIntoRelevantField(error){
        if(!formInput) cacheFormElements()
        element = formInput[error.field]
        element.value = error.message

      }



</script>
</html>