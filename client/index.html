<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <style>
    </style>
    <title>TaxApple</title>

</head>
<body>
    <h1>Calculator</h1>
        <div>
            <form onsubmit="calculate()">
                <div class="form-group" id="calculatorForm">
                </div>
            </form>
        </div>
    </body>
<script>

    //todo: onchange,
    //cache the values here (i.e., as state)
    //and process-update the values in the components.
    //see if bootstrap has a default "alert" that can be used
    //make it so the button is not enabled unless all of the fields have been given definite values
    //figure out why the missing values arent being treated as null

    const calculateURL = "http://localhost:3000/calculate" //note: be sure that you don't change the server code so that it possible pings a different port than 3000
    const digitPattern = "\\d+"
    const monetaryAmountPattern = "\\d+(\.\\d{1,2})?"
    function parseInputWithPattern(input, pattern){
      const matches = input.match(pattern)
      return matches ? matches[0] : ""
    }

    const formFields = {
      currentTaxRate: {label: "Your Current Marginal Tax Rate", placeholder: "15%", pattern: digitPattern},
      amountInvested: {
        label: "The Amount You Intend To Invest",
        placeholder: "1000.00$",
        pattern: monetaryAmountPattern
      },
      retirementTaxRate: {label: "Your Retirement Tax Rate", placeholder: "5%", pattern: digitPattern},
      investmentGrowthRate: {label: "Your Investment Growth Rate", placeholder: "3%", pattern: digitPattern},
      inflationRate: {label: "The Inflation Rate", placeholder: "5%", pattern: digitPattern},
      yearsInvested: {label: "Years You Plan To Invest", placeholder: "30", pattern: digitPattern}
    }

    createFormInputFields()

    function createFormInputFields(){
      var formGroup = document.getElementById("calculatorForm")
      Object.keys(formFields).map(function(field){
            const fieldData = formFields[field]
            const label = fieldData.label
            const placeholder= fieldData.placeholder
            formGroup.insertAdjacentHTML("beforeEnd", '<label for="'+field+'">'+label+'</label>');
            formGroup.insertAdjacentHTML("beforeEnd", '<input type="text" placeholder="'+placeholder+'" class="form-control" id="'+field+'">');
      })
      formGroup.insertAdjacentHTML("beforeEnd",'<button type="submit" class="btn btn-default">Submit</button>')
    }


    var formInput = null //lazily initialize on first call to calculate.
    //elements aren't mounted to DOM when the script initially executes.

    function cacheFormElements(){
      formInput = Object.keys(formFields).reduce(function(acc, field){
        acc[field] = document.getElementById(field)
        return acc
      }, {})
    }

    //todo: want to validate each field first; send immediate feedback to client so they can correct the mistake.
    //however, should build analogous validations into the server
    function calculate(){
      if(!formInput) cacheFormElements();
      var params  = Object.keys(formInput).reduce(function(acc, fieldName){
        acc[fieldName] = parseInputWithPattern(formInput[fieldName].value, formFields[fieldName].pattern)
        return acc
      }, {});

      //nb, will need to define input cleaners for each (define them in the object) that extract the appropriate data
      //from it using regex

      alert(JSON.stringify(params))

      var request = new XMLHttpRequest()

      request.open("POST", calculateURL, true)
      request.setRequestHeader("Accept", "application/json")
      request.setRequestHeader("Content-Type", "application/json")

      request.onreadystatechange = function () {
        if(request.readyState === XMLHttpRequest.DONE) {
          switch(request.status){
            case 200:
              alert("done: "+request.responseText); //todo need to populate another element with the result of the request
              break;
            case 400:
              alert("error: "+request.responseText) //todo populate the fields with result.
              break;
          }

        }
      }


      request.send(JSON.stringify(params))
      event.preventDefault()

    }


</script>
</html>